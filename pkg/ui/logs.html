<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JHub Apps Proxy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FAFBFC;
            color: #1e293b;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem 1rem 1rem;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .header {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 120px;
            height: auto;
            margin-bottom: 0.5rem;
        }


        .title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }

        .title.error {
            color: #991b1b;
        }


        .progress-container {
            width: 24rem;
            height: 0.25rem;
            background: #e2e8f0;
            position: relative;
            overflow: hidden;
            visibility: visible;
        }

        .progress-container.hidden {
            visibility: hidden;
        }

        .progress-indicator {
            position: absolute;
            height: 100%;
            width: 4rem;
            background: #1e293b;
            animation: slide 1.5s ease-in-out infinite;
        }

        @keyframes slide {
            0% {
                left: -4rem;
            }
            100% {
                left: 100%;
            }
        }

        .section {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .section-header {
            background: #1e293b;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #334155;
            font-size: 0.875rem;
            color: #94a3b8;
            font-family: 'IBM Plex Mono', 'SF Mono', 'Monaco', 'Consolas', monospace;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header svg {
            width: 1rem;
            height: 1rem;
            color: #64748b;
        }

        .copy-button {
            background: #334155;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s;
        }

        .copy-button:hover {
            background: #475569;
            color: #cbd5e1;
        }

        .copy-button svg {
            width: 0.875rem;
            height: 0.875rem;
        }

        .copy-button.copied {
            background: #166534;
            border-color: #16a34a;
            color: #86efac;
        }

        .auto-redirect-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .toggle-switch {
            position: relative;
            width: 2.5rem;
            height: 1.25rem;
            background: #334155;
            border-radius: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #475569;
        }

        .toggle-switch.active {
            background: #3b82f6;
            border-color: #60a5fa;
        }

        .toggle-slider {
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            width: 0.875rem;
            height: 0.875rem;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(1.25rem);
        }

        .section-content {
            padding: 0.75rem 1rem;
            background: #0f172a;
        }

        .command {
            font-family: 'IBM Plex Mono', 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            color: #4ade80;
        }

        .command-prompt {
            color: #64748b;
            margin-right: 0.5rem;
        }

        .logs-content {
            height: 24rem;
            overflow-y: auto;
            font-family: 'IBM Plex Mono', 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .logs-content::-webkit-scrollbar {
            width: 6px;
        }

        .logs-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .logs-content::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        .logs-content::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .log-line {
            color: #cbd5e1;
            padding: 0.125rem 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-stderr {
            color: #f87171;
        }

        .log-placeholder {
            color: #64748b;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .footer {
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .footer a {
            color: #64748b;
            text-decoration: none;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer a:hover {
            color: #334155;
        }

        .footer svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        @media (max-width: 768px) {
            .container {
                gap: 1rem;
            }
            .title {
                font-size: 1.25rem;
            }
            .logs-content {
                height: 18rem;
            }
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        <div class="header">
            <img id="logo" alt="Nebari Logo" class="logo">
            <div>
                <h1 class="title" id="title">Deploying your application</h1>
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-indicator"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                    Running Command
                </div>
                <button class="copy-button" id="copyCommand" title="Copy command">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy
                </button>
            </div>
            <div class="section-content">
                <div class="command">
                    <span class="command-prompt">$</span>
                    <span id="commandText">Loading...</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-header-left">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                    Logs
                </div>
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <div class="auto-redirect-toggle">
                        <span>Auto-scroll</span>
                        <div class="toggle-switch active" id="autoScrollToggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <button class="copy-button" id="copyLogs" title="Copy all logs">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Copy
                    </button>
                </div>
            </div>
            <div class="section-content logs-content" id="logs">
                <div class="log-line log-placeholder">Waiting for output...</div>
            </div>
        </div>

        <div class="footer">
            <a href="https://github.com/nebari-dev/jhub-app-proxy" target="_blank">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <span id="versionText">jhub-app-proxy</span>
            </a>
        </div>
    </div>

    <script>
        const logsContainer = document.getElementById('logs');
        const title = document.getElementById('title');
        const progressContainer = document.getElementById('progressContainer');
        const commandText = document.getElementById('commandText');
        const versionText = document.getElementById('versionText');
        const logo = document.getElementById('logo');
        const autoScrollToggle = document.getElementById('autoScrollToggle');

        let isReady = false;
        let lastLogCount = 0;

        // Auto-scroll state (default: true)
        let autoScrollEnabled = localStorage.getItem('autoScroll') !== 'false';

        // Initialize toggle state
        if (!autoScrollEnabled) {
            autoScrollToggle.classList.remove('active');
        }

        // Toggle handler
        autoScrollToggle.addEventListener('click', function() {
            autoScrollEnabled = !autoScrollEnabled;
            this.classList.toggle('active');
            localStorage.setItem('autoScroll', autoScrollEnabled);
        });

        // Load logo
        async function loadLogo() {
            try {
                const response = await fetch('api/logo');
                const data = await response.json();
                if (data.logo) {
                    logo.src = 'data:' + data.type + ';base64,' + data.logo;
                }
            } catch (err) {
                console.error('Failed to load logo:', err);
            }
        }

        function scrollToBottom() {
            if (autoScrollEnabled) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        function addLog(stream, line) {
            const firstPlaceholder = logsContainer.querySelector('.log-placeholder');
            if (firstPlaceholder) {
                logsContainer.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = 'log-line' + (stream === 'stderr' ? ' log-stderr' : '');
            div.textContent = line;
            logsContainer.appendChild(div);
            scrollToBottom();
        }

        async function checkAppStatus() {
            try {
                const response = await fetch('api/logs/stats');
                const data = await response.json();

                if (data.process_info && data.process_info.command) {
                    commandText.textContent = data.process_info.command.join(' ');
                }

                if (data.version) {
                    versionText.textContent = 'jhub-app-proxy v' + data.version;
                } else {
                    versionText.textContent = 'jhub-app-proxy';
                }

                if (data.process_state) {
                    const state = data.process_state.state;

                    if (state === 'running' && !isReady) {
                        isReady = true;
                        progressContainer.classList.add('hidden');
                        title.innerHTML = 'Application ready, redirecting...';
                        // Reload the page to show the running application
                        window.location.reload();
                    } else if (state === 'failed') {
                        title.innerHTML = 'Your app failed to deploy, please fix your mistakes!';
                        title.classList.add('error');
                        progressContainer.classList.add('hidden');
                    }
                }
            } catch (err) {
                console.error('Failed to check status:', err);
            }
        }

        let isInitialLoad = true;
        async function loadAllLogs() {
            try {
                const response = await fetch('api/logs/all');
                const data = await response.json();

                if (data.logs && data.logs.length > 0) {
                    logsContainer.innerHTML = '';
                    data.logs.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'log-line';
                        if (line.includes('[stderr]')) {
                            div.className = 'log-line log-stderr';
                        }
                        div.textContent = line;
                        logsContainer.appendChild(div);
                    });
                    scrollToBottom();
                }
            } catch (err) {
                console.error('Failed to load historical logs:', err);
                addLog('stderr', 'Error loading historical logs: ' + err.message);
            }
            isInitialLoad = false;
        }

        async function fetchRecentLogs() {
            if (isInitialLoad) return;

            try {
                const response = await fetch('api/logs?lines=100');
                const data = await response.json();

                if (data.logs && data.logs.length > 0) {
                    if (data.stats.total_lines > lastLogCount) {
                        data.logs.forEach(log => {
                            addLog(log.stream, log.line);
                        });
                        lastLogCount = data.stats.total_lines;
                    }
                }
            } catch (err) {
                console.error('Error fetching logs:', err);
            }
        }

        // Copy functionality
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                // Show success feedback
                const originalText = button.innerHTML;
                button.classList.add('copied');
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Copied!
                `;

                // Reset after 2 seconds
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        document.getElementById('copyCommand').addEventListener('click', function() {
            const command = commandText.textContent;
            copyToClipboard(command, this);
        });

        document.getElementById('copyLogs').addEventListener('click', function() {
            const logLines = Array.from(logsContainer.querySelectorAll('.log-line'))
                .map(line => line.textContent)
                .join('\n');
            copyToClipboard(logLines, this);
        });

        // Initial calls
        loadLogo();
        checkAppStatus();
        loadAllLogs().then(() => {
            setInterval(fetchRecentLogs, 1000);
        });
        setInterval(checkAppStatus, 2000);
    </script>
</body>
</html>
